---
// src/components/Header.astro  — Landqo (logo unificado con el footer)
/**
 * - Fondo inicial sólido (var(--color-bg)) para no interferir con el hero.
 * - Scroll (>12px) o menú móvil abierto: sombra sutil; SIN blur.
 * - Logo: isotipo + wordmark iguales al footer (consistencia de marca).
 * - CTA “Empezar” → WhatsApp (mismo comportamiento que footer).
 */
import { CONTACT } from "@/utils/contact";

const isHome =
  Astro.url.pathname === "/" ||
  Astro.url.pathname === "/index" ||
  Astro.url.pathname === "/index.html";

const BRAND = (import.meta.env.PUBLIC_BRAND_NAME || "Landqo").trim();
const homeHash = (id: string): string => (isHome ? `#${id}` : `/#${id}`);

// CTA a WhatsApp (igual que footer)
const ctaLink = CONTACT.ctaLink({
  intent: "contacto",
  source: "navbar",
  fallback: "#cta",
});
---

<header
  id="siteHeader"
  role="banner"
  class="fixed top-0 inset-x-0 z-[1000] isolate"
>
  <div class="container flex items-center justify-between h-16">
    <!-- Brand -->
    <a href="/#" class="brand" aria-label={`${BRAND} — ir al inicio`}>
      <svg class="brand-iso" viewBox="0 0 64 64" role="img" aria-hidden="true">
        <rect
          x="6"
          y="6"
          width="52"
          height="52"
          rx="14"
          fill="var(--color-primary)"></rect>
        <path d="M22 18h8v24h20v8H22z" fill="#fff"></path>
      </svg>
      <span class="brand-word">
        <span class="strong">{BRAND.slice(0, 4) || "Land"}</span>
        <span class="muted">{BRAND.slice(4) || "qo"}</span>
      </span>
    </a>

    <!-- Desktop nav -->
    <nav
      class="hidden md:flex items-center gap-1"
      aria-label="Navegación principal"
    >
      <a
        href={homeHash("features")}
        class="nav-link hover:bg-[color:var(--color-bg-elev)]"
        >Características</a
      >
      <a
        href={homeHash("templates")}
        class="nav-link hover:bg-[color:var(--color-bg-elev)]">Plantillas</a
      >

      <a
        href={homeHash("use-cases")}
        class="nav-link hover:bg-[color:var(--color-bg-elev)]">Casos de uso</a
      >
      <a
        href={homeHash("pricingOnePay")}
        class="nav-link hover:bg-[color:var(--color-bg-elev)]">Precios</a
      >

      <a
        href={homeHash("faq")}
        class="nav-link hover:bg-[color:var(--color-bg-elev)]">FAQ</a
      >

      <!-- CTA a WhatsApp (igual que footer) -->
      <a
        href={ctaLink.href}
        class="btn btn-primary h-10 px-4 ml-2"
        target={ctaLink.target}
        rel={ctaLink.rel}
        aria-label="Empezar"
      >
        Empezar
      </a>
    </nav>

    <!-- Mobile: CTA + menú -->
    <div class="md:hidden flex items-center gap-2">
      <!-- CTA a WhatsApp (igual que footer) -->
      <a
        href={ctaLink.href}
        class="btn btn-primary h-10 px-4"
        target={ctaLink.target}
        rel={ctaLink.rel}
        aria-label="Empezar"
      >
        Empezar
      </a>

      <button
        id="menuBtn"
        class="inline-flex items-center justify-center rounded-lg h-10 w-10 border border-[color:var(--color-border)] hover:bg-[color:var(--color-bg-elev)]"
        aria-controls="mobileNav"
        aria-expanded="false"
        aria-label="Abrir menú"
      >
        <svg
          id="iconOpen"
          class="h-5 w-5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-width="2"
            d="M4 7h16M4 12h16M4 17h16"></path>
        </svg>
        <svg
          id="iconClose"
          class="h-5 w-5 hidden"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-width="2"
            d="M6 6l12 12M18 6l-12 12"></path>
        </svg>
        <span class="sr-only">Menú</span>
      </button>
    </div>
  </div>
</header>

<!-- Overlay móvil -->
<div
  id="mobileOverlay"
  class="md:hidden hidden fixed inset-x-0 bottom-0 bg-black/60"
  style="top: var(--header-h, 64px); z-index: 998;"
  role="presentation"
>
</div>

<!-- Panel móvil -->
<nav
  id="mobileNav"
  class="md:hidden hidden fixed inset-x-0 bg-[color:var(--color-surface)] shadow-2xl overflow-y-auto"
  style="top: var(--header-h, 64px); height: calc(100dvh - var(--header-h, 64px)); z-index: 999;"
  role="dialog"
  aria-modal="true"
  aria-label="Menú principal"
>
  <div class="container py-4">
    <ul class="flex flex-col gap-1 text-base">
      <li>
        <a
          href={homeHash("features")}
          class="nav-link w-full h-12 px-3 rounded-lg hover:bg-[color:var(--color-bg-elev)]"
          >Características</a
        >
      </li>
      <li>
        <a
          href={homeHash("templates")}
          class="nav-link w-full h-12 px-3 rounded-lg hover:bg-[color:var(--color-bg-elev)]"
          >Plantillas</a
        >
      </li>
      <li>
        <a
          href={homeHash("pricingOnePay")}
          class="nav-link w-full h-12 px-3 rounded-lg hover:bg-[color:var(--color-bg-elev)]"
          >Precios</a
        >
      </li>
      <li>
        <a
          href={homeHash("use-cases")}
          class="nav-link w-full h-12 px-3 rounded-lg hover:bg-[color:var(--color-bg-elev)]"
          >Casos de uso</a
        >
      </li>

      <li>
        <a
          href={homeHash("faq")}
          class="nav-link w-full h-12 px-3 rounded-lg hover:bg-[color:var(--color-bg-elev)]"
          >FAQ</a
        >
      </li>
    </ul>
    <div class="mt-4 pt-4 [box-shadow:inset_0_1px_0_var(--color-border)]">
      <!-- CTA a WhatsApp (igual que footer) -->
      <a
        href={ctaLink.href}
        class="btn btn-primary w-full h-12 rounded-xl"
        target={ctaLink.target}
        rel={ctaLink.rel}
        aria-label="Empezar"
      >
        Empezar
      </a>
    </div>
  </div>
</nav>

<style is:inline>
  :root {
    --header-h: 64px;
  }

  /* Fondo sólido desde el inicio (no interfiere con el hero) */
  #siteHeader {
    background-color: var(--color-bg) !important;
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    box-shadow: none !important;
    border-bottom: 1px solid
      color-mix(in oklch, var(--color-border) 35%, transparent);
    background-clip: padding-box;
    transform: translateZ(0);
    transition:
      box-shadow 0.25s ease,
      border-color 0.25s ease;
  }

  /* Scroll / menú abierto → elevación sutil */
  #siteHeader.header--scrolled,
  body.menu-open #siteHeader {
    box-shadow: 0 8px 28px hsl(220 3% 15% / 0.1);
    border-bottom-color: color-mix(
      in oklch,
      var(--color-border) 75%,
      transparent
    );
  }

  [data-theme="dark"] #siteHeader {
    border-bottom-color: color-mix(
      in oklch,
      var(--color-border) 50%,
      transparent
    );
  }
  [data-theme="dark"] #siteHeader.header--scrolled {
    box-shadow: 0 10px 32px hsl(220 3% 5% / 0.28);
    border-bottom-color: color-mix(
      in oklch,
      var(--color-border) 70%,
      transparent
    );
  }

  #siteHeader .btn {
    line-height: 1;
  }

  .brand {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    color: inherit;
    text-decoration: none;
  }
  .brand-iso {
    width: 2rem;
    height: 2rem;
    flex: none;
  }
  .brand-word {
    display: inline-flex;
    align-items: baseline;
    line-height: 1;
    letter-spacing: -0.01em;
  }
  .brand-word .strong {
    font-weight: 800;
    font-size: clamp(1.15rem, 1.2rem + 0.3vw, 1.35rem);
  }
  .brand-word .muted {
    font-weight: 800;
    font-size: clamp(1.15rem, 1.2rem + 0.3vw, 1.35rem);
    color: color-mix(in oklch, var(--color-fg) 60%, transparent);
  }
</style>

<script is:inline>
  (function () {
    const $ = (id) => document.getElementById(id);

    // Stacking correcto
    (function () {
      const header = $("siteHeader"),
        overlay = $("mobileOverlay"),
        panel = $("mobileNav");
      if (!header) return;
      if (header.parentElement !== document.body) {
        document.body.prepend(header);
        if (overlay) document.body.appendChild(overlay);
        if (panel) document.body.appendChild(panel);
      }
    })();

    const header = $("siteHeader");
    const btn = $("menuBtn");
    const panel = $("mobileNav");
    const overlay = $("mobileOverlay");
    const iconOpen = $("iconOpen");
    const iconClose = $("iconClose");

    function setHeaderH() {
      const h = (header && header.offsetHeight) || 64;
      document.documentElement.style.setProperty("--header-h", h + "px");
    }
    setHeaderH();
    addEventListener("resize", setHeaderH, { passive: true });

    // Apertura/cierre móvil + focus trap
    const roots = Array.from(
      document.querySelectorAll("main, #pageRoot, #app, [data-app-root]"),
    );
    let lastFocused = null;
    const focusableSel =
      'a[href],button:not([disabled]),[tabindex]:not([tabindex="-1"])';

    function trapFocus(container, e) {
      if (e.key !== "Tab") return;
      const nodes = Array.from(container.querySelectorAll(focusableSel)).filter(
        (el) => el.offsetParent !== null,
      );
      if (!nodes.length) return;
      const first = nodes[0],
        last = nodes[nodes.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
    function onKeydownTrap(e) {
      trapFocus(panel, e);
    }

    function scrollbarW() {
      return window.innerWidth - document.documentElement.clientWidth;
    }
    function setOpen(toggle) {
      const willOpen =
        typeof toggle === "boolean"
          ? toggle
          : panel.classList.contains("hidden");
      if (willOpen) lastFocused = document.activeElement;

      panel.classList.toggle("hidden", !willOpen);
      overlay.classList.toggle("hidden", !willOpen);
      if (btn) btn.setAttribute("aria-expanded", String(willOpen));
      if (iconOpen) iconOpen.classList.toggle("hidden", willOpen);
      if (iconClose) iconClose.classList.toggle("hidden", !willOpen);
      document.body.classList.toggle("overflow-hidden", willOpen);
      document.body.classList.toggle("menu-open", willOpen);
      document.body.style.paddingRight = willOpen ? scrollbarW() + "px" : "";

      roots.forEach((el) => el && el.toggleAttribute("inert", willOpen));
      if (willOpen) {
        (panel.querySelector(focusableSel) || panel).focus();
        panel.addEventListener("keydown", onKeydownTrap);
      } else {
        panel.removeEventListener("keydown", onKeydownTrap);
        if (lastFocused && lastFocused.focus) lastFocused.focus();
        else if (btn && btn.focus) btn.focus();
      }
    }

    if (btn) btn.addEventListener("click", () => setOpen());
    if (overlay) overlay.addEventListener("click", () => setOpen(false));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });
    (panel ? panel.querySelectorAll("a") : []).forEach((a) =>
      a.addEventListener("click", () => setOpen(false)),
    );
    const mq = matchMedia("(min-width: 768px)");
    if (mq && mq.addEventListener)
      mq.addEventListener("change", (e) => {
        if (e.matches) setOpen(false);
      });

    // Scroll: activa solo la sombra
    const SCROLL_THRESHOLD = 12;
    function onScroll() {
      if (header)
        header.classList.toggle(
          "header--scrolled",
          window.scrollY > SCROLL_THRESHOLD,
        );
    }
    requestAnimationFrame(onScroll);
    addEventListener("scroll", onScroll, { passive: true });

    // Anchors con offset del header
    function getHashId(href) {
      if (!href) return "";
      const i = href.indexOf("#");
      return i >= 0 ? href.slice(i + 1) : "";
    }
    document.addEventListener("click", function (e) {
      const t = e.target;
      if (!(t instanceof Element)) return;
      const a = t.closest(
        'a[href^="#"]:not([data-no-offset]), a[href^="/#"]:not([data-no-offset])',
      );
      if (!a) return;
      const id = getHashId(a.getAttribute("href") || "");
      const el = document.getElementById(id);
      if (!el) return;
      e.preventDefault();
      const h = (header && header.offsetHeight) || 64;
      const reduced = matchMedia("(prefers-reduced-motion: reduce)").matches;
      const y = Math.max(
        0,
        el.getBoundingClientRect().top + window.scrollY - h - 12,
      );
      window.scrollTo({ top: y, behavior: reduced ? "auto" : "smooth" });
    });

    // Respetar hash al aterrizar
    function scrollToHashIfNeeded() {
      if (!location.hash) return;
      const el = document.getElementById(location.hash.slice(1));
      if (!el) return;
      requestAnimationFrame(function () {
        const h = (header && header.offsetHeight) || 64;
        const y = Math.max(
          0,
          el.getBoundingClientRect().top + window.scrollY - h - 12,
        );
        window.scrollTo({ top: y, behavior: "smooth" });
      });
    }
    addEventListener("load", scrollToHashIfNeeded);
    addEventListener("hashchange", scrollToHashIfNeeded);
  })();
</script>
